name: '${APPLICATION_NAME}'
services:
    kpi:
        container_name: ${PHP_CONTAINER_NAME}
        build:
            context: ./config
            dockerfile: Dockerfile.dev.web
            args:
                USER_ID: ${USER_ID}
                GROUP_ID: ${GROUP_ID}
                BASE_IMAGE_PHP: ${BASE_IMAGE_PHP}
        user: ${USER_ID}:${GROUP_ID}
        ports:
            - 80${DOCKER_SUFFIXE_PORT}:80
        volumes:
            - ../sources:/var/www/html
            - ${HOST_WORDPRESS_PATH}:/var/www/html/wordpress
            - ./MyParams.php:/var/www/html/commun/MyParams.php
            - ./MyConfig.php:/var/www/html/commun/MyConfig.php
            - ./config/opcache-dev.ini:/usr/local/etc/php/conf.d/opcache-dev.ini
            - ${HOST_APACHE2_LOG_PATH}:/var/log/apache2/
        networks:
            - network_kpi
            - traefiknetwork
        depends_on:
            - db
        logging:
            driver: "json-file"
            options:
                max-size: 10m
                max-file: 3
        restart: unless-stopped
        labels:
            - "traefik.enable=true"
            # HTTP (pour dev local .localhost)
            - "traefik.http.routers.kpi-http.rule=Host(\`${KPI_DOMAIN_NAME}\`)"
            - "traefik.http.routers.kpi-http.entrypoints=web"
            # HTTPS (pour dev avec domaines personnalisés)
            - "traefik.http.routers.kpi-https.rule=Host(\`${KPI_DOMAIN_NAME}\`)"
            - "traefik.http.routers.kpi-https.entrypoints=websecure"
            - "traefik.http.routers.kpi-https.tls=true"
    kpi8:
        container_name: ${PHP_CONTAINER_NAME}8
        build:
            context: ./config
            dockerfile: Dockerfile.dev.web
            args:
                USER_ID: ${USER_ID}
                GROUP_ID: ${GROUP_ID}
                BASE_IMAGE_PHP: ${BASE_IMAGE_PHP_8}
        user: ${USER_ID}:${GROUP_ID}
        ports:
            - 88${DOCKER_SUFFIXE_PORT}:80
        volumes:
            - ../sources:/var/www/html
            - ${HOST_WORDPRESS_PATH}:/var/www/html/wordpress
            - ./MyParams.php:/var/www/html/commun/MyParams.php
            - ./MyConfig.php:/var/www/html/commun/MyConfig.php
            - ./config/opcache-dev.ini:/usr/local/etc/php/conf.d/opcache-dev.ini
            - ${HOST_APACHE2_LOG_PATH_8}:/var/log/apache2/
        networks:
            - network_kpi
            - traefiknetwork
        depends_on:
            - db
        logging:
            driver: "json-file"
            options:
                max-size: 10m
                max-file: 3
        restart: unless-stopped
        labels:
            - "traefik.enable=true"
            # HTTP (pour dev local .localhost)
            - "traefik.http.routers.kpi8-http.rule=Host(\`${KPI_DOMAIN_NAME_8}\`)"
            - "traefik.http.routers.kpi8-http.entrypoints=web"
            # HTTPS (pour dev avec domaines personnalisés)
            - "traefik.http.routers.kpi8-https.rule=Host(\`${KPI_DOMAIN_NAME_8}\`)"
            - "traefik.http.routers.kpi8-https.entrypoints=websecure"
            - "traefik.http.routers.kpi8-https.tls=true"
    db:
        container_name: ${DB_CONTAINER_NAME}
        build:
            context: ./config
            dockerfile: Dockerfile.db
            args:
                BASE_IMAGE_DB: ${BASE_IMAGE_DB}
        command: mysqld --sql_mode=""
        volumes:
            - ${HOST_DB_PATH}:/var/lib/mysql/
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
            MYSQL_USER: ${DB_USER}
            MYSQL_PASSWORD: ${DB_PASSWORD}
            MYSQL_DATABASE: ${DB_NAME}
        # ports:
        #     - 33${DOCKER_SUFFIXE_PORT}:3306
        networks:
            - network_kpi
            - pma_network
        logging:
            driver: "json-file"
            options:
                max-size: 10m
                max-file: 3
        restart: unless-stopped
    dbwp:
        container_name: ${DBWP_CONTAINER_NAME}
        build:
            context: ./config
            dockerfile: Dockerfile.db
            args:
                BASE_IMAGE_DB: ${BASE_IMAGE_DB}
        volumes:
            - ${HOST_DBWP_PATH}:/var/lib/mysql/
        environment:
            MYSQL_ROOT_PASSWORD: ${DBWP_ROOT_PASSWORD}
            MYSQL_USER: ${DBWP_USER}
            MYSQL_PASSWORD: ${DBWP_PASSWORD}
            MYSQL_DATABASE: ${DBWP_NAME}
        # ports:
        #     - 33${DOCKER_SUFFIXE_PORT}:3306
        networks:
            - network_kpi
            - pma_network
        logging:
            driver: "json-file"
            options:
                max-size: 10m
                max-file: 3
        restart: unless-stopped
    node_app2:
        container_name: kpi_node_app2
        build:
            context: ../sources/app2
            dockerfile: ../../docker/node/Dockerfile
        working_dir: /app
        user: "${USER_ID}:${GROUP_ID}"
        volumes:
            - ../sources/app2:/app
        environment:
            - HOST=0.0.0.0
            - PORT=3000
        networks:
            - network_kpi
            - traefiknetwork
        ports:
            - "3002:3000"
        restart: unless-stopped
        labels:
            - "traefik.enable=true"
            # HTTP (pour dev local .localhost)
            - "traefik.http.routers.app2-http.rule=Host(\`${APP2_DOMAIN_NAME}\`)"
            - "traefik.http.routers.app2-http.entrypoints=web"
            - "traefik.http.services.app2.loadbalancer.server.port=3000"
            # HTTPS (pour dev avec domaines personnalisés)
            - "traefik.http.routers.app2-https.rule=Host(\`${APP2_DOMAIN_NAME}\`)"
            - "traefik.http.routers.app2-https.entrypoints=websecure"
            - "traefik.http.routers.app2-https.tls=true"
    
    node_app2_wsm:
        container_name: kpi_node_app2_wsm
        build:
            context: ../sources/app2_wsm
            dockerfile: ../../docker/node/Dockerfile
        working_dir: /app
        user: "${USER_ID}:${GROUP_ID}"
        volumes:
            - ../sources/app2_wsm:/app
        environment:
            - HOST=0.0.0.0
            - PORT=3000
        networks:
            - network_kpi
            - traefiknetwork
        ports:
            - "3003:3000"
        restart: unless-stopped
        labels:
            - "traefik.enable=true"
            # HTTP (pour dev local .localhost)
            - "traefik.http.routers.app2wsm-http.rule=Host(\`${APP2_WSM_DOMAIN_NAME}\`)"
            - "traefik.http.routers.app2wsm-http.entrypoints=web"
            - "traefik.http.services.app2wsm.loadbalancer.server.port=3000"
            # HTTPS (pour dev avec domaines personnalisés)
            - "traefik.http.routers.app2wsm-https.rule=Host(\`${APP2_WSM_DOMAIN_NAME}\`)"
            - "traefik.http.routers.app2wsm-https.entrypoints=websecure"
            - "traefik.http.routers.app2wsm-https.tls=true"

networks:
    network_kpi:
        name: network_${APPLICATION_NAME}
        external: true
    pma_network:
        name: pma_network
        external: true
    traefiknetwork:
        name: traefiknetwork
        external: true
